<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="kubernetes 概述 kubernetes 基本介绍 kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。
传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配 置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于 可移植性。
新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件 系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进 行迁移。"><meta property="og:title" content><meta property="og:description" content="kubernetes 概述 kubernetes 基本介绍 kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。
传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配 置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于 可移植性。
新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件 系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进 行迁移。"><meta property="og:type" content="website"><meta property="og:image" content="https://jieye-ericx.github.io/icon.png"><meta property="og:url" content="https://jieye-ericx.github.io/K8S/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="kubernetes 概述 kubernetes 基本介绍 kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。
传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配 置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于 可移植性。
新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件 系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进 行迁移。"><meta name=twitter:image content="https://jieye-ericx.github.io/icon.png"><title>ericx 's 数字花园</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://jieye-ericx.github.io//icon.png><link href=https://jieye-ericx.github.io/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://jieye-ericx.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://jieye-ericx.github.io/js/darkmode.48459b7116d092b4e98d2cab704cad80.min.js></script>
<script src=https://jieye-ericx.github.io/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://jieye-ericx.github.io/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://jieye-ericx.github.io/",fetchData=Promise.all([fetch("https://jieye-ericx.github.io/indices/linkIndex.978b539fabc6a7a29a0ecd89a7f575a5.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://jieye-ericx.github.io/indices/contentIndex.e4f1617822572a37abb893fb2b9f5e7c.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://jieye-ericx.github.io",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://jieye-ericx.github.io",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/jieye-ericx.github.io\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=jieye-ericx.github.io src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://jieye-ericx.github.io/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://jieye-ericx.github.io/>ericx 's 数字花园</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/K8S.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#kubernetes-基本介绍>kubernetes 基本介绍</a></li><li><a href=#kubernetes-功能和架构>kubernetes 功能和架构</a></li></ol><ol><li><a href=#1-安装要求>1. 安装要求</a></li><li><a href=#2准备环境>2.准备环境</a></li><li><a href=#3-所有节点安装dockerkubeadmkubelet>3. 所有节点安装Docker/kubeadm/kubelet</a><ol><li><a href=#31-安装docker>3.1 安装Docker</a></li><li><a href=#32-添加阿里云yum软件源>3.2 添加阿里云YUM软件源</a></li><li><a href=#33-安装kubeadmkubelet和kubectl>3.3 安装kubeadm，kubelet和kubectl</a></li></ol></li><li><a href=#4-部署kubernetes-master>4. 部署Kubernetes Master</a></li><li><a href=#5-加入kubernetes-node>5. 加入Kubernetes Node</a></li><li><a href=#6-部署pod网络插件cni>6. 部署Pod网络插件(CNI)</a></li><li><a href=#7-测试kubernetes集群>7. 测试kubernetes集群</a></li></ol><ol><li><a href=#yaml-文件书写格式>YAML 文件书写格式</a></li><li><a href=#资源清单描述方法>资源清单描述方法</a></li></ol></nav></details></aside><a href=#kubernetes-概述><h1 id=kubernetes-概述><span class=hanchor arialabel=Anchor># </span>kubernetes 概述</h1></a><a href=#kubernetes-基本介绍><h2 id=kubernetes-基本介绍><span class=hanchor arialabel=Anchor># </span>kubernetes 基本介绍</h2></a><p>kubernetes，简称 K8s，是用 8 代替 8 个字符“ubernete”而成的缩写。是一个开源 的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的 应用简单并且高效（powerful）,Kubernetes 提供了应用部署，规划，更新，维护的一种 机制。</p><p>传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配 置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等 操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于 可移植性。</p><p>新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件 系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署， 由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进 行迁移。</p><p>容器占用资源少、部署快，每个应用可以被打包成一个容器镜像，每个应用与容器间 成一对一关系也使容器有更大优势，使用容器可以在 build 或 release 的阶段，为应用创 建容器镜像，因为每个应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构， 这使得从研发到测试、生产能提供一致环境。类似地，容器比虚拟机轻量、更“透明”， 这更便于监控和管理。</p><p>Kubernetes 是 Google 开源的一个容器编排引擎，它支持自动化部署、大规模可伸缩、 应用容器化管理。在生产环境中部署一个应用程序时，通常要部署该应用的多个实例以便 对应用请求进行负载均衡。</p><p>在 Kubernetes 中，我们可以创建多个容器，每个容器里面运行一个应用实例，然后通 过内置的负载均衡策略，实现对这一组应用实例的管理、发现、访问，而这些细节都不需 要运维人员去进行复杂的手工配置和处理。</p><a href=#kubernetes-功能和架构><h2 id=kubernetes-功能和架构><span class=hanchor arialabel=Anchor># </span>kubernetes 功能和架构</h2></a><p>Kubernetes 是一个轻便的和可扩展的开源平台，用于管理容器化应用和服务。通过 Kubernetes 能够进行应用的自动化部署和扩缩容。在 Kubernetes 中，会将组成应用的容 器组合成一个逻辑单元以更易管理和发现。Kubernetes 积累了作为 Google 生产环境运行 工作负载 15 年的经验，并吸收了来自于社区的最佳想法和实践。</p><p><strong>K8s 功能:</strong></p><ol><li><p><strong>自动装箱</strong></p><p>基于容器对应用运行环境的资源配置要求自动部署应用容器</p></li><li><p><strong>自我修复(自愈能力)</strong></p><p>当容器失败时，会对容器进行重启 当所部署的 Node 节点有问题时，会对容器进行重新部署和重新调度当容器未通过监控检查时，会关闭此容器直到容器正常运行时，才会对外提供服务</p></li><li><p><strong>水平扩展</strong></p><p>通过简单的命令、用户 UI 界面或基于 CPU 等资源使用情况，对应用容器进行规模扩大 或规模剪裁</p></li><li><p><strong>服务发现</strong></p><p>用户不需使用额外的服务发现机制，就能够基于 Kubernetes 自身能力实现服务发现和 负载均衡</p></li><li><p><strong>滚动更新</strong></p><p>可以根据应用的变化，对应用容器运行的应用，进行一次性或批量式更新</p></li><li><p><strong>版本回退</strong></p><p>可以根据应用部署情况，对应用容器运行的应用，进行历史版本即时回退</p></li><li><p><strong>密钥和配置管理</strong></p><p>在不需要重新构建镜像的情况下，可以部署和更新密钥和应用配置，类似热部署。</p></li><li><p><strong>存储编排</strong></p><p>自动实现存储系统挂载及应用，特别对有状态应用实现数据持久化非常重要 存储系统可以来自于本地目录、网络存储(NFS、Gluster、Ceph 等)、公共云存储服务</p></li><li><p><strong>批处理</strong></p><p>提供一次性任务，定时任务；满足批量数据处理和分析的场景</p></li></ol><p><strong>!!!应用部署架构分类:</strong></p><ul><li>无中心节点架构:GlusterFS</li><li>有中心节点架构:HDFS、K8s</li></ul><p><strong>k8s 集群架构</strong></p><p><img src=https://jieye-ericx.github.io//K8S.assets/02-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%20%E6%A6%82%E8%BF%B0%E7%89%B9%E6%80%A7%E5%92%8C%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6.png width=auto alt="02-第一部分 概述特性和架构组件"></p><p>关于Pod、controller、service:</p><p><img src=https://jieye-ericx.github.io//K8S.assets/03-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%20%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5.png width=auto alt="03-第一部分 核心概念"></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210405232541227.png width=auto alt=image-20210405232541227></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210405233640570.png width=auto alt=image-20210405233640570></p><a href=#kubernetes-集群搭建kubeadm-方式><h1 id=kubernetes-集群搭建kubeadm-方式><span class=hanchor arialabel=Anchor># </span>kubernetes 集群搭建(kubeadm 方式)</h1></a><p><img src=https://jieye-ericx.github.io//K8S.assets/04-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%20k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%EF%BC%88%E5%B9%B3%E5%8F%B0%E8%A7%84%E5%88%92%E5%92%8C%E6%90%AD%E5%BB%BA%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D%EF%BC%89-1617636541020.png width=auto alt="04-第二部分 k8s集群搭建（平台规划和搭建方式介绍）"></p><p>目前生产部署 Kubernetes 集群主要有两种方式：</p><ol><li><p>Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部 署 Kubernetes 集群。</p><p>官方地址：https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</p></li><li><p>从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。 Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可 控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很 多工作原理，也利于后期维护。</p></li></ol><a href=#1-安装要求><h2 id=1-安装要求><span class=hanchor arialabel=Anchor># </span>1. 安装要求</h2></a><p>在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：</p><ol><li>一台或多台机器，操作系统 CentOS7.x-86_x64</li><li>硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多</li><li>集群中所有机器之间网络互通</li><li>可以访问外网，需要拉取镜像</li><li>禁止 swap 分区</li></ol><p><strong>最终目标：</strong></p><ol><li>在所有节点上安装 Docker 和 kubeadm</li><li>部署 Kubernetes Master</li><li>部署容器网络插件</li><li>部署 Kubernetes Node，将节点加入 Kubernetes 集群中</li><li>部署 Dashboard Web 页面，可视化查看 Kubernetes 资源</li></ol><a href=#2准备环境><h2 id=2准备环境><span class=hanchor arialabel=Anchor># </span>2.准备环境</h2></a><table><thead><tr><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>192.168.1.11</td></tr><tr><td>node1</td><td>192.168.1.12</td></tr><tr><td>node2</td><td>192.168.1.13</td></tr></tbody></table><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 关闭防火墙</span>
</span></span><span class=line><span class=cl>systemctl stop firewalld
</span></span><span class=line><span class=cl>systemctl disable firewalld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 关闭selinux</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config  <span class=c1># 永久</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>  <span class=c1># 临时</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 关闭swap</span>
</span></span><span class=line><span class=cl>swapoff -a  <span class=c1># 临时</span>
</span></span><span class=line><span class=cl>sed -ri <span class=s1>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab    <span class=c1># 永久</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 根据规划设置主机名</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname &lt;hostname&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在master添加hosts</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/hosts <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>192.168.44.146 k8smaster
</span></span></span><span class=line><span class=cl><span class=s>192.168.44.145 k8snode1
</span></span></span><span class=line><span class=cl><span class=s>192.168.44.144 k8snode2
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将桥接的IPv4流量传递到iptables的链</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/sysctl.d/k8s.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sysctl --system  <span class=c1># 生效</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 时间同步</span>
</span></span><span class=line><span class=cl>yum install ntpdate -y
</span></span><span class=line><span class=cl>ntpdate time.windows.com
</span></span></code></pre></td></tr></table></div></div><a href=#3-所有节点安装dockerkubeadmkubelet><h2 id=3-所有节点安装dockerkubeadmkubelet><span class=hanchor arialabel=Anchor># </span>3. 所有节点安装Docker/kubeadm/kubelet</h2></a><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p><a href=#31-安装docker><h3 id=31-安装docker><span class=hanchor arialabel=Anchor># </span>3.1 安装Docker</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span class=line><span class=cl>$ yum -y install docker-ce-18.06.1.ce-3.el7
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> docker <span class=o>&amp;&amp;</span> systemctl start docker
</span></span><span class=line><span class=cl>$ docker --version
</span></span><span class=line><span class=cl>Docker version 18.06.1-ce, build e68fc7a
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; /etc/docker/daemon.json <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;registry-mirrors&#34;: [&#34;https://b9pmyelo.mirror.aliyuncs.com&#34;]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><a href=#32-添加阿里云yum软件源><h3 id=32-添加阿里云yum软件源><span class=hanchor arialabel=Anchor># </span>3.2 添加阿里云YUM软件源</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat &gt; /etc/yum.repos.d/kubernetes.repo <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><a href=#33-安装kubeadmkubelet和kubectl><h3 id=33-安装kubeadmkubelet和kubectl><span class=hanchor arialabel=Anchor># </span>3.3 安装kubeadm，kubelet和kubectl</h3></a><p>由于版本更新频繁，这里指定版本号部署：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> kubelet
</span></span></code></pre></td></tr></table></div></div><a href=#4-部署kubernetes-master><h2 id=4-部署kubernetes-master><span class=hanchor arialabel=Anchor># </span>4. 部署Kubernetes Master</h2></a><p>在192.168.31.61（Master）执行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm init <span class=se>\\ </span></span></span><span class=line><span class=cl><span class=se></span>  --apiserver-advertise-address<span class=o>=</span>192.168.44.146 <span class=se>\\ </span></span></span><span class=line><span class=cl><span class=se></span>  --image-repository registry.aliyuncs.com/google_containers <span class=se>\\ </span></span></span><span class=line><span class=cl><span class=se></span>  --kubernetes-version v1.18.0 <span class=se>\\ </span></span></span><span class=line><span class=cl><span class=se></span>  --service-cidr<span class=o>=</span>10.96.0.0/12 <span class=se>\\ </span></span></span><span class=line><span class=cl><span class=se></span>  --pod-network-cidr<span class=o>=</span>10.244.0.0/16
</span></span></code></pre></td></tr></table></div></div><p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p><p>使用kubectl工具：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>$ kubectl get nodes
</span></span></code></pre></td></tr></table></div></div><a href=#5-加入kubernetes-node><h2 id=5-加入kubernetes-node><span class=hanchor arialabel=Anchor># </span>5. 加入Kubernetes Node</h2></a><p>在192.168.1.12/13（Node）执行。</p><p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm join 192.168.1.11:6443 --token esce21.q6hetwm8si29qxwn <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5
</span></span></code></pre></td></tr></table></div></div><p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubeadm token create --print-join-command
</span></span></code></pre></td></tr></table></div></div><a href=#6-部署pod网络插件cni><h2 id=6-部署pod网络插件cni><span class=hanchor arialabel=Anchor># </span>6. 部署Pod网络插件(CNI)</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></td></tr></table></div></div><p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>kube-flannel-ds-amd64-2pc95   1/1     Running   <span class=m>0</span>          72s
</span></span></code></pre></td></tr></table></div></div><a href=#7-测试kubernetes集群><h2 id=7-测试kubernetes集群><span class=hanchor arialabel=Anchor># </span>7. 测试kubernetes集群</h2></a><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create deployment nginx --image<span class=o>=</span>nginx
</span></span><span class=line><span class=cl>$ kubectl expose deployment nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort
</span></span><span class=line><span class=cl>$ kubectl get pod,svc
</span></span></code></pre></td></tr></table></div></div><p>访问地址：http://NodeIP:Port</p><p><img src=https://jieye-ericx.github.io//K8S.assets/05-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%20%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4%EF%BC%88kubeadm%E6%96%B9%E5%BC%8F%EF%BC%89.png width=auto alt="05-第二部分 搭建k8s集群（kubeadm方式）"></p><a href=#kubernetes-集群搭建二进制方式><h1 id=kubernetes-集群搭建二进制方式><span class=hanchor arialabel=Anchor># </span>kubernetes 集群搭建(二进制方式)</h1></a><p>太多了，不做记录</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210405235850079.png width=auto alt=image-20210405235850079></p><a href=#两种搭建方式比较><h1 id=两种搭建方式比较><span class=hanchor arialabel=Anchor># </span>两种搭建方式比较</h1></a><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210405235901869.png width=auto alt=image-20210405235901869></p><a href=#kubernetes-集群命令行工具-kubectl><h1 id=kubernetes-集群命令行工具-kubectl><span class=hanchor arialabel=Anchor># </span>kubernetes 集群命令行工具 kubectl</h1></a><p>kubectl 是 Kubernetes 集群的命令行工具，通过 kubectl 能够对集群本身进行管理，并能 够在集群上进行容器化应用的安装部署。</p><p><strong>语法</strong></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000150664.png width=auto alt=image-20210406000150664></p><ol><li>comand：指定要对资源执行的操作，例如 create、get、describe 和 delete</li><li>TYPE：指定资源类型，资源类型是大小写敏感的，开发者能够以单数、复数和缩略的 形式。例如：
<img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000230980.png width=auto alt=image-20210406000230980></li><li>NAME：指定资源的名称，名称也大小写敏感的。如果省略名称，则会显示所有的资源， 例如:
<img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000242678.png width=auto alt=image-20210406000242678></li><li>flags：指定可选的参数。例如，可用-s 或者–server 参数指定 Kubernetes API server 的地址和端口</li></ol><p>help 获取更多信息：</p><ol><li><p>基础命令</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000511903.png width=auto alt=image-20210406000511903></p></li><li><p>部署和集群管理命令</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000522903.png width=auto alt=image-20210406000522903></p></li><li><p>故障和调试命令</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000535911.png width=auto alt=image-20210406000535911></p></li><li><p>其他命令</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406000548920.png width=auto alt=image-20210406000548920></p></li></ol><a href=#kubernetes-集群-yaml-文件详解><h1 id=kubernetes-集群-yaml-文件详解><span class=hanchor arialabel=Anchor># </span>kubernetes 集群 YAML 文件详解</h1></a><p>k8s 集群中对资源管理和资源对象编排部署都可以通过声明样式（YAML）文件来解决，也 就是可以把需要对资源对象操作编辑到 YAML 格式文件中，我们把这种文件叫做资源清单文 件，通过 kubectl 命令直接使用资源清单文件就可以实现对大量的资源对象进行编排部署了。</p><a href=#yaml-文件书写格式><h2 id=yaml-文件书写格式><span class=hanchor arialabel=Anchor># </span>YAML 文件书写格式</h2></a><p>YAML仍是一种标记语言。为了强调这种语言以数据做为中心，而不是以标记语言为重点。 YAML 是一个可读性高，用来表达数据序列的格式。</p><p><strong>YAML 基本语法</strong></p><ul><li><p>使用空格做为缩进，缩进的空格数目不重要，只要相同层级的元素左侧对齐即可。</p></li><li><p>低版本缩进时不允许使用 Tab 键，只允许使用空格。</p></li><li><p>使用#标识注释，从这个字符一直到行尾，都会被解释器忽略</p></li></ul><p><strong>YAML 支持的数据结构</strong></p><ul><li><p>对象,又称为映射(mapping) / 哈希（hashes） / 字典（dictionary）</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172347015.png width=auto alt=image-20210406172347015></p></li><li><p>数组,又称为序列（sequence） / 列表 （list）</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172406935.png width=auto alt=image-20210406172406935></p></li><li><p>纯量（scalars）,单个的、不可再分的值</p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172443325.png width=auto alt=image-20210406172443325></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172521880.png width=auto alt=image-20210406172521880></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172526594.png width=auto alt=image-20210406172526594></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172534285.png width=auto alt=image-20210406172534285></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172541999.png width=auto alt=image-20210406172541999></p><p><img src=https://jieye-ericx.github.io//K8S.assets/image-20210406172553600.png width=auto alt=image-20210406172553600></p></li></ul><a href=#资源清单描述方法><h2 id=资源清单描述方法><span class=hanchor arialabel=Anchor># </span>资源清单描述方法</h2></a><p>在 k8s 中，一般使用 YAML 格式的文件来创建符合我们预期期望的 pod,这样的 YAML 文件称为资源清单。</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://jieye-ericx.github.io/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Jieye ericx using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://jieye-ericx.github.io/>Home</a></li><li><a href=https://github.com/jieye-ericx>Github</a></li></ul></footer></div></div></body></html>