<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="1.前端组件库的设计原则 1.1 细粒度的考量 我们在学习设计模式的时候会遇到很多种设计原则,其中一个设计原则就是单一职责原则,在组件库的开发中同样适用,我们原则上一个组件只专注一件事情,单一职责的组件的好处很明显,由于职责单一就可以最大可能性地复用组件,但是这也带来一个问题,过度单一职责的组件也可能会导致过度抽象,造成组件库的碎片化。
举个例子，一个自动完成组件(AutoComplete),他其实是由 Input 组件和 Select 组件组合而成的,因此我们完全可以复用之前的相关组件,就比如 Antd 的 AutoComplete 组件中就复用了 Select 组件,同时 Calendar、 Form 等等一系列组件都复用了 Select 组件,那么 Select 的细粒度就是合适的,因为 Select 保持的这种细粒度很容易被复用."><meta property="og:title" content="组件库设计"><meta property="og:description" content="1.前端组件库的设计原则 1.1 细粒度的考量 我们在学习设计模式的时候会遇到很多种设计原则,其中一个设计原则就是单一职责原则,在组件库的开发中同样适用,我们原则上一个组件只专注一件事情,单一职责的组件的好处很明显,由于职责单一就可以最大可能性地复用组件,但是这也带来一个问题,过度单一职责的组件也可能会导致过度抽象,造成组件库的碎片化。
举个例子，一个自动完成组件(AutoComplete),他其实是由 Input 组件和 Select 组件组合而成的,因此我们完全可以复用之前的相关组件,就比如 Antd 的 AutoComplete 组件中就复用了 Select 组件,同时 Calendar、 Form 等等一系列组件都复用了 Select 组件,那么 Select 的细粒度就是合适的,因为 Select 保持的这种细粒度很容易被复用."><meta property="og:type" content="website"><meta property="og:image" content="https://jieye-ericx.github.io/icon.png"><meta property="og:url" content="https://jieye-ericx.github.io/%E7%BB%84%E4%BB%B6%E5%BA%93%E8%AE%BE%E8%AE%A1/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="组件库设计"><meta name=twitter:description content="1.前端组件库的设计原则 1.1 细粒度的考量 我们在学习设计模式的时候会遇到很多种设计原则,其中一个设计原则就是单一职责原则,在组件库的开发中同样适用,我们原则上一个组件只专注一件事情,单一职责的组件的好处很明显,由于职责单一就可以最大可能性地复用组件,但是这也带来一个问题,过度单一职责的组件也可能会导致过度抽象,造成组件库的碎片化。
举个例子，一个自动完成组件(AutoComplete),他其实是由 Input 组件和 Select 组件组合而成的,因此我们完全可以复用之前的相关组件,就比如 Antd 的 AutoComplete 组件中就复用了 Select 组件,同时 Calendar、 Form 等等一系列组件都复用了 Select 组件,那么 Select 的细粒度就是合适的,因为 Select 保持的这种细粒度很容易被复用."><meta name=twitter:image content="https://jieye-ericx.github.io/icon.png"><title>组件库设计</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://jieye-ericx.github.io//icon.png><link href=https://jieye-ericx.github.io/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://jieye-ericx.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://jieye-ericx.github.io/js/darkmode.48459b7116d092b4e98d2cab704cad80.min.js></script>
<script src=https://jieye-ericx.github.io/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://jieye-ericx.github.io/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://jieye-ericx.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://jieye-ericx.github.io/",fetchData=Promise.all([fetch("https://jieye-ericx.github.io/indices/linkIndex.762b6dcff4c3893cdd65608c69e9b98c.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://jieye-ericx.github.io/indices/contentIndex.6a179d12fa1d9130ce0cd4a8041d389b.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://jieye-ericx.github.io",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://jieye-ericx.github.io",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/jieye-ericx.github.io\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=jieye-ericx.github.io src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://jieye-ericx.github.io/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://jieye-ericx.github.io/>jieye の 数字花园</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>组件库设计</h1><p class=meta>Last updated
Jun 26, 2022</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1前端组件库的设计原则>1.前端组件库的设计原则</a><ol><li><a href=#11-细粒度的考量>1.1 细粒度的考量</a></li><li><a href=#12-通用性考量>1.2 通用性考量</a></li></ol></li><li><a href=#2-技术选型>2 技术选型</a><ol><li><a href=#21-css-解决方案>2.1 css 解决方案</a></li><li><a href=#22-js-解决方案>2.2 js 解决方案</a></li></ol></li><li><a href=#3-如何快速启动一个组件库项目>3. 如何快速启动一个组件库项目</a><ol><li><a href=#31-打包工具rollup-vs-webpack>3.1 打包工具(rollup vs webpack)</a></li></ol></li><li><a href=#4-如何设计一个轮播图组件-notion>4. 如何设计一个轮播图组件 notion</a><ol><li><a href=#41-轮播图基本原理>4.1 轮播图基本原理</a></li></ol></li></ol></nav></details></aside><a href=#1前端组件库的设计原则><h2 id=1前端组件库的设计原则><span class=hanchor arialabel=Anchor># </span>1.前端组件库的设计原则</h2></a><a href=#11-细粒度的考量><h3 id=11-细粒度的考量><span class=hanchor arialabel=Anchor># </span>1.1 细粒度的考量</h3></a><p>我们在学习设计模式的时候会遇到很多种设计原则,其中一个设计原则就是<strong>单一职责原则</strong>,在组件库的开发中同样适用,我们原则上一个组件只专注一件事情,单一职责的组件的好处很明显,由于职责单一就可以最大可能性地复用组件,但是这也带来一个问题,过度单一职责的组件也可能会导致过度抽象,造成组件库的碎片化。</p><p>举个例子，一个自动完成组件(AutoComplete),他其实是由 Input 组件和 Select 组件组合而成的,因此我们完全可以复用之前的相关组件,就比如 Antd 的 AutoComplete 组件中就复用了 Select 组件,同时 Calendar、 Form 等等一系列组件都复用了 Select 组件,那么 Select 的细粒度就是合适的,因为 Select 保持的这种细粒度很容易被复用.</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182538.png width=auto alt=img></p><p>那么还有一个例子,一个徽章数组件(Badge),它的右上角会有红点提示,可能是数字也可能是 icon,他的职责当然也很单一，这个红点提示也理所当然也可以被单独抽象为一个独立组件,但是我们通常不会将他作为独立组件,因为在其他场景中这个组件是无法被复用的，因为没有类似的场景再需要小红点这个小组件了，所以作为独立组件就属于细粒度过小,因此我们往往将它作为 Badge 的内部组件,比如在 Antd 中它以 ScrollNumber 的名称作为 Badge 的内部组件存在。</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182534.png width=auto alt=img></p><p>所以，所谓的单一职责组件要建立在可复用的基础上，对于不可复用的单一职责组件我们仅仅作为独立组件的内部组件即可。</p><a href=#12-通用性考量><h3 id=12-通用性考量><span class=hanchor arialabel=Anchor># </span>1.2 通用性考量</h3></a><p>我们要设计的本身就是通用组件库,不同于我们常见的业务组件,通用组件是与业务解耦但是又服务于业务开发的,那么问题来了,如何保证组件的通用性,通用性高一定是好事吗?</p><p>比如我们设计一个选择器(Select)组件,通常我们会设计成这样</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182531.png width=auto alt=img></p><p>这是一个我们最常见也最常用的选择器,但是问题是其通用性大打折扣</p><p>当我们有一个需求是长这样的时候,我们之前的选择器组件就不符合要求了,因为这个 Select 组件的最下部需要有一个可拓展的条目的按钮</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182525.png width=auto alt=img></p><p>这个时候我们难道要重新修改之前的选择器组件,甚至再造一个符合要求的选择器组件吗?一旦有这种情况发生,那么只能说明之前的选择器组件通用性不够,需要我们重新设计.</p><p>Antd 的 Select 组件预留了<code>dropdownRender</code>来进行自定义渲染,其依赖的 <code>rc-select</code>组件中的代码如下</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182524.png width=auto alt=img></p><blockquote><p>Antd 依赖了大量以<code>rc-</code>开头的底层组件,这些组件被 react-component 团队(同时也就是 Antd 团队)维护,其主要实现组件的底层逻辑,Antd 则是在此基础上添加 Ant Design 设计语言而实现的</p></blockquote><p>当然类似的设计还有很多,通用性设计其实是一定意义上放弃对 DOM 的掌控,而将 DOM 结构的决定权转移给开发者,<code>dropdownRender</code>其实就是放弃对 Select 下拉菜单中条目的掌控,Antd 的 Select 组件其实还有一个没有在文档中体现的方法<code>getInputElement</code>应该是对 Input 组件的自定义方法,Antd 整个 Select 的组件设计非常复杂,基本将所有的 DOM 结构控制权全部暴露给了开发者,其本身只负责底层逻辑和最基本的 DOM 结构.</p><p>这是 Antd 所依赖的 re-select 最终 jsx 的结构,其 DOM 结构很简单,但是暴露了大量自定义渲染的接口给开发者.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>SelectTrigger</span>
</span></span><span class=line><span class=cl>        <span class=na>onPopupFocus</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onPopupFocus</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onMouseEnter</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onMouseEnter</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onMouseLeave</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onMouseLeave</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownAlign</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownAlign</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownClassName</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownClassName</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownMatchSelectWidth</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownMatchSelectWidth</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>defaultActiveFirstOption</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>defaultActiveFirstOption</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownMenuStyle</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownMenuStyle</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>transitionName</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>transitionName</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>animation</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>animation</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>prefixCls</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>prefixCls</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownStyle</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownStyle</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>combobox</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>combobox</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>showSearch</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>showSearch</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>options</span><span class=o>=</span><span class=p>{</span><span class=nx>options</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>multiple</span><span class=o>=</span><span class=p>{</span><span class=nx>multiple</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>disabled</span><span class=o>=</span><span class=p>{</span><span class=nx>disabled</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>visible</span><span class=o>=</span><span class=p>{</span><span class=nx>realOpen</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>inputValue</span><span class=o>=</span><span class=p>{</span><span class=nx>state</span><span class=p>.</span><span class=nx>inputValue</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>value</span><span class=o>=</span><span class=p>{</span><span class=nx>state</span><span class=p>.</span><span class=nx>value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>backfillValue</span><span class=o>=</span><span class=p>{</span><span class=nx>state</span><span class=p>.</span><span class=nx>backfillValue</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>firstActiveValue</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>firstActiveValue</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onDropdownVisibleChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onDropdownVisibleChange</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>getPopupContainer</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>getPopupContainer</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onMenuSelect</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onMenuSelect</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onMenuDeselect</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onMenuDeselect</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>onPopupScroll</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>onPopupScroll</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>showAction</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>showAction</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>ref</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>saveSelectTriggerRef</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>menuItemSelectedIcon</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>menuItemSelectedIcon</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>dropdownRender</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>dropdownRender</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>ariaId</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>ariaId</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span>
</span></span><span class=line><span class=cl>          <span class=na>id</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>style</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>style</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>ref</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>saveRootRef</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>onBlur</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onOuterBlur</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>onFocus</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>onOuterFocus</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>className</span><span class=o>=</span><span class=p>{</span><span class=nx>classnames</span><span class=p>(</span><span class=nx>rootCls</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>          <span class=na>onMouseDown</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>markMouseDown</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>onMouseUp</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>markMouseLeave</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=na>onMouseOut</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>markMouseLeave</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>div</span>
</span></span><span class=line><span class=cl>            <span class=na>ref</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>saveSelectionRef</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=na>key</span><span class=o>=</span><span class=s>&#34;selection&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>className</span><span class=o>=</span><span class=p>{</span><span class=sb>`</span><span class=si>${</span><span class=nx>prefixCls</span><span class=si>}</span><span class=sb>-selection
</span></span></span><span class=line><span class=cl><span class=sb>            </span><span class=si>${</span><span class=nx>prefixCls</span><span class=si>}</span><span class=sb>-selection--</span><span class=si>${</span><span class=nx>multiple</span> <span class=o>?</span> <span class=s1>&#39;multiple&#39;</span> <span class=o>:</span> <span class=s1>&#39;single&#39;</span><span class=si>}</span><span class=sb>`</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=na>role</span><span class=o>=</span><span class=s>&#34;combobox&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>aria</span><span class=err>-</span><span class=na>autocomplete</span><span class=o>=</span><span class=s>&#34;list&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>aria</span><span class=err>-</span><span class=na>haspopup</span><span class=o>=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>aria</span><span class=err>-</span><span class=na>controls</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>ariaId</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=na>aria</span><span class=err>-</span><span class=na>expanded</span><span class=o>=</span><span class=p>{</span><span class=nx>realOpen</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=na>...extraSelectionProps</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>ctrlNode</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>renderClear</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>renderArrow</span><span class=p>(</span><span class=o>!!</span><span class=nx>multiple</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>          <span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>SelectTrigger</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>那么这么多需要自定义的地方,这个 Select 组件岂不是很难用?因为好像所有地方都需要开发者自定义,通用性设计在将 DOM 结构决定权交给开发者的同时也保留了默认结构,在开发者没有显示自定义的时候默认使用默认渲染结构,其实 Select 的基本使用很方便,如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>select</span> <span class=na>defaultvalue</span><span class=o>=</span><span class=s>&#34;lucy&#34;</span> <span class=na>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>width</span><span class=o>:</span> <span class=mi>120</span> <span class=p>}}</span> <span class=na>disabled</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;lucy&#34;</span><span class=p>&gt;</span><span class=nx>LucyOption</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>Select</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>组件的形态(DOM 结构)永远是千变万化的,但是其行为(逻辑)是固定的,因此通用组件的秘诀之一就是将 DOM 结构的控制权交给开发者,组件只负责行为和最基本的 DOM 结构</p></blockquote><hr><a href=#2-技术选型><h2 id=2-技术选型><span class=hanchor arialabel=Anchor># </span>2 技术选型</h2></a><a href=#21-css-解决方案><h3 id=21-css-解决方案><span class=hanchor arialabel=Anchor># </span>2.1 css 解决方案</h3></a><p>由于 CSS 本身的众多缺陷，如书写繁琐（不支持嵌套）、样式易冲突（没有作用域概念）、缺少变量（不便于一键换主题）等不一而足。为了解决这些问题，社区里的解决方案也是出了一茬又一茬，从最早的 CSS prepocessor（SASS、LESS、Stylus）到后来的后起之秀 PostCSS，再到 CSS Modules、Styled-Components 等。</p><p>Antd 选择了 less 作为 css 的预处理方案,Bootstrap 选择了 Scss,这两种方案孰优孰劣已经争论了很多年了:</p><p>SCSS 和 LESS 相比有什么优势？</p><p>但是不管是哪种方案都有一个很烦人的点,就是需要额外引入 css,比如 Antd 需要这样显示引入:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import Button from &#39;antd/lib/button&#39;;
</span></span><span class=line><span class=cl>import &#39;antd/lib/button/style&#39;;
</span></span></code></pre></td></tr></table></div></div><p>为了解决这种尴尬的情况,Antd 用 Babel 插件将这种情况 Hack 掉了</p><p>而<code>material-ui</code>并不存在这种情况,他不需要显示引入 css,这个最流行的 React 前端组件库里面只有 js 和 ts 两种代码,并不存在 css 相关的代码,为什么呢?</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182516.png width=auto alt=image-20200714180847810></p><p>他们用 <code>jss</code> 作为 css-in-js 的解决方案,jsx 的引入已经将 js 和 html 耦合,css-in-js 将 css 也耦合进去,此时组件便不需要显示引入 css,而是直接引用 js 即可.</p><p>这不是退化到史前前端那种写内联样式的时代了吗?</p><p>并不是,史前前端的内联样式是整个项目耦合的状态,当然要被抛弃到历史的垃圾堆中,后来的样式和逻辑分离,实际上是以页面为维度将 js css html 解耦的过程,如今的时代是组件化的时代了,jsx 已经将 js 和 html 框定到一个组件中,css 依然处于分离状态,这就导致了每次引用组件却还需要显示引入 css,css-in-js 正式彻底组件化的解决方案.</p><p>当然,我个人目前在用 styled-components,其优点引用如下:</p><ol><li>首先，styled-components 所有语法都是标准 css 语法，同时支持 scss 嵌套等常用语法，覆盖了所有 css 场景。</li><li>在样式复写场景下，styled-components 支持在任何地方注入全局 css，就像写普通 css 一样</li><li>styled-components 支持自定义 className，两种方式，一种是用 babel 插件, 另一种方式是使用 styled.div.withConfig({ componentId: &ldquo;prefix-button-container&rdquo; }) 相当于添加 className=&ldquo;prefix-button-container&rdquo;</li><li>className 语义化更轻松，这也是 class 起名的初衷</li><li>更适合组件库使用，直接引用 import &ldquo;module&rdquo; 即可，否则你有三条路可以走：像 antd 一样，单独引用 css，你需要给 node_modules 添加 css-loader；组件内部直接 import css 文件，如果任何业务项目没有 css-loader 就会报错；组件使用 scss 引用，所有业务项目都要配置一份 scss-loader 给 node_modules；这三种对组件库来说，都没有直接引用来的友好</li><li>当你写一套组件库，需要单独发包，又有统一样式的配置文件需求，如果这个配置文件是 js 的，所有组件直接引用，对外完全不用关注。否则，如果是 scss 配置文件，摆在面前还是三条路：每个组件单独引用 scss 文件，需要每个业务项目给 node_modules 添加 scss-loader（如果业务用了 less，还要装一份 scss 是不）；或者业务方只要使用了你的组件库，就要在入口文件引用你的 scss 文件，比如你的组件叫 button，scss 可能叫 common-css，别人听都没听过，还要查文档；或者业务方在 webpack 配置中单独引用你的 common-css，这也不科学，如果用了 3 个组件库，天天改 webpack 配置也很不方便。</li><li>当 css 设置了一半样式，另一半真的需要 js 动态传入，你不得不 css + css-in-js 混合使用，项目久了，维护的时候发现某些 css-in-js 不变了，可以固化在 css 里，css 里固定的值又因为新去求变得可变了，你又得拿出来放在 css-in-js 里，实践过就知道有多么烦心。</li></ol><a href=#22-js-解决方案><h3 id=22-js-解决方案><span class=hanchor arialabel=Anchor># </span>2.2 js 解决方案</h3></a><p>选 Typescript ,因为巨硬大法好…</p><hr><a href=#3-如何快速启动一个组件库项目><h2 id=3-如何快速启动一个组件库项目><span class=hanchor arialabel=Anchor># </span>3. 如何快速启动一个组件库项目</h2></a><p>组件的具体实现部分当然是组件库的核心,但是在现代前端库中其他部分也必不可少,我们需要一堆工具来辅助我们开发,例如编译工具、代码检测工具、打包工具等等。</p><a href=#31-打包工具rollup-vs-webpack><h3 id=31-打包工具rollup-vs-webpack><span class=hanchor arialabel=Anchor># </span>3.1 打包工具(rollup vs webpack)</h3></a><p>市面上打包工具数不胜数,最火爆的当然是需要配置工程师专门配置的 webpack,但是在类库开发领域它有一个强大的对手就是 rollup。</p><p>现代市面上主流的库基本都选择了 rollup 作为打包工具，包括 Angular React 和 Vue, 作为基础类库的打包工具 rollup 的优势如下:</p><ul><li>Tree Shaking: 自动移除未使用的代码, 输出更小的文件</li><li>Scope Hoisting: 所有模块构建在一个函数内, 执行效率更高</li><li>Config 文件支持通过 ESM 模块格式书写
可以一次输出多种格式:</li><li>模块规范: IIFE, AMD, CJS, UMD, ESM Development 与 production 版本: .js, .min.js</li></ul><p>虽然上面部分功能已经被 webpack 实现了,但是 rollup 明显引入得更早,而 Scope Hoisting 更是杀手锏,由于 webpack 不得不在打包代码中构建模块系统来适应 app 开发(模块系统对于单一类库用处很小),Scope Hoisting 将模块构建在一个函数内的做法更适合类库的打包.</p><a href=#32-代码检测><h4 id=32-代码检测><span class=hanchor arialabel=Anchor># </span>3.2 代码检测</h4></a><p>由于 JavaScript 各种诡异的特性和大型前端项目的出现,代码检测工具已经是前端开发者的标配了,Douglas Crockford 最早于 2002 创造出了 JSLint,但是其无法拓展,具有极强的 Douglas Crockford 个人色彩,Anton Kovalyov 由于无法忍受 JSLint 无法拓展的行为在 2011 年发布了可拓展的 JSHint,一时之间 JSHint 成为了前端代码检测的流行解决方案.</p><p>随后的 2013 年,Nicholas C. Zakas 鉴于 JSHint 拓展的灵活度不够的问题开发了全新的基于 AST 的 Lint 工具 ESLint,并随着 ES6 的流行统治了前端界,ESLint 基于 Esprima 进行 JavaScript 解析的特性极易拓展,JSHint 在很长一段时间无法支持 ES6 语法导致被 ESLint 超越.</p><p>但是在 Typescript 领域 ESLint 却处于弱势地位,TSLint 的出现要比 ESLint 正式支持 Typescript 早很多,<em>目前 TSLint 似乎是 TS 的事实上的代码检测工具</em>.</p><blockquote><p>注: 文章成文较早,我也没想到前阵子 TS 官方钦点了 ESLint,TSLint 失宠了,面向未来的官方标配的代码检测工具肯定是 ESLint 了,但是 TSLint 目前依然被大量使用,现在仍然可以放心使用</p></blockquote><p>代码检测工具是一方面,代码检测风格也需要我们做选择,市面上最流行的代码检测风格应该是 Airbnb 出品的<code>eslint-config-airbnb</code>,其最大的特点就是极其严格,没有给开发者任何选择的余地,当然在大型前端项目的开发中这种严格的代码风格是有利于协作的,但是作为一个类库的代码检测工具而言并不适合,所以我们选择了<code>eslint-config-standard</code>这种相对更为宽松的代码检测风格.</p><a href=#33-commit-规范><h4 id=33-commit-规范><span class=hanchor arialabel=Anchor># </span>3.3 commit 规范</h4></a><p>以下两种 commit 哪个更严谨且易于维护?</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182508.jpeg width=auto alt=img></p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182506.png width=auto alt=img></p><p>最开始使用 commit 的时候我也经常犯下图的错误,直到看到很多明星类库的 commit 才意识到自己的错误,写好 commit message 不仅有助于他人 review, 还可以有效的输出 CHANGELOG, 对项目的管理实际至关重要.</p><p>目前流行的方案是 Angular 团队的规范,其关于 head 的大致规范如下:</p><ul><li>type: commit 的类型</li><li>feat: 新特性</li><li>fix: 修改问题</li><li>refactor: 代码重构</li><li>docs: 文档修改</li><li>style: 代码格式修改, 注意不是 css 修改</li><li>test: 测试用例修改</li><li>chore: 其他修改, 比如构建流程, 依赖管理.</li><li>scope: commit 影响的范围, 比如: route, component, utils, build…</li><li>subject: commit 的概述, 建议符合 50/72 formatting</li><li>body: commit 具体修改内容, 可以分为多行, 建议符合 50/72 formatting</li><li>footer: 一些备注, 通常是 BREAKING CHANGE 或修复的 bug 的链接.</li></ul><p>当然规范人们不一定会遵守,我最初知道此类规范的时候也并没有严格遵循,因为人总会偷懒,直到用<code>commitizen</code>将此规范集成到工具流中,每个 commit 就不得不遵循规范了.</p><p>我具体参考了这篇文章: 优雅的提交你的 Git Commit Message</p><a href=#34-测试工具><h4 id=34-测试工具><span class=hanchor arialabel=Anchor># </span>3.4 测试工具</h4></a><p>业务开发中由于前端需求变动频繁的特性,导致前端对测试的要求并没有后端那么高,后端业务逻辑一旦定型变动很少,比较适合测试.</p><p>但是基础类库作为被反复依赖的模块和较为稳定的需求是必须做测试的,前端测试库也可谓是种类繁多了,经过比对之后我还是选择了目前最流行也是被三大框架同时选择了的 Jest 作为测试工具,其优点很明显:</p><ol><li>开箱即用,内置断言、测试覆盖率工具,如果你用 MoCha 那可得自己手动配置 n 多了</li><li>快照功能,Jest 可以利用其特有的快照测试功能，通过比对 UI 代码生成的快照文件</li><li>速度优势,Jest 的测试用例是并行执行的，而且只执行发生改变的文件所对应的测试，提升了测试速度</li></ol><a href=#35-其它><h4 id=35-其它><span class=hanchor arialabel=Anchor># </span>3.5 其它</h4></a><p>当然以上是主要工具的选择,还有一些比如:</p><ul><li>代码美化工具 prettier,解放人肉美化,同时利于不同人协作的风格一致</li><li>持续集成工具 travis-ci,解放人肉测试 lint,利于保证每次 push 的可靠程度</li></ul><a href=#36-快速启动脚手架><h4 id=36-快速启动脚手架><span class=hanchor arialabel=Anchor># </span>3.6 快速启动脚手架</h4></a><p>那么以上这么多配置难道要我们每次都自己写吗?组件的具体实现才是组件库的核心,我们为什么要花这么多时间在配置上面?</p><p>我们在建立 APP 项目时通常会用到框架官方提供的脚手架,比如 React 的 create-react-app,Angular 的 Angular-Cli 等等,那么能不能有一个专门用于组件开发的快速启动的脚手架呢?</p><p>有的,我最近开发了一款快速启动组件库开发的命令行工具&ndash;create-component</p><blockquote><p><a href=https://github.com/xiaomuzhu/create-component rel=noopener>https://github.com/xiaomuzhu/create-component</a></p></blockquote><p>利用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1create-component init
</span></span></code></pre></td></tr></table></div></div><p>来快速启动项目,我们提供了丰富的可选配置,只要你做好技术选型后,根据提示去选择配置即可,create-component 会自动根据配置生成脚手架,其灵感就来源于 vue-cli 和 Angular-cli.</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182456.jpeg width=auto alt=img></p><hr><a href=#4-如何设计一个轮播图组件-notion><h2 id=4-如何设计一个轮播图组件-notion><span class=hanchor arialabel=Anchor># </span>4. 如何设计一个轮播图组件 notion</h2></a><p>说了很多理论,那么实战如何呢?设计一个通用组件试试吧!</p><a href=#41-轮播图基本原理><h3 id=41-轮播图基本原理><span class=hanchor arialabel=Anchor># </span>4.1 轮播图基本原理</h3></a><p>轮播图(Carousel),在 Antd 中被称为走马灯,可能是前端开发者最常见的组件之一了,不管是在 PC 端还是在移动端我们总能见到他的身影.</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182453.png width=auto alt=image-20200714181317645></p><p>那么我们通常是如何使用轮播图的呢?Antd 的代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>1
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>Carousel</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  2
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      1h3&gt;div&gt; 3
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          2h3&gt;div&gt; 4
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>              3h3&gt;div&gt; 5
</span></span><span class=line><span class=cl>              <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>4h3&gt;div&gt; 6 Carousel&gt;<span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>Carousel</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>问题是我们在<code>Carousel</code>中放入了四组<code>div</code>为什么一次只显示一组呢?</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182451.png width=auto alt=image-20200714181338491></p><p>图中被红框圈住的为可视区域,可视区域的位置是固定的,我们只需要移动后面<code>div</code>的位置就可以做到 1 2 3 4 四个子组件轮播的效果,那么子组件 2 目前在可视区域是可以被看到的,1 3 4 应该被隐藏,这就需要我们设置 overflow 属性为 hidden 来隐藏非可视区域的子组件.</p><blockquote><p>复制查看动图:
<a href=https://images2015.cnblogs.com/blog/979044/201707/979044-20170710105934040-1007626405.gif rel=noopener>https://images2015.cnblogs.com/blog/979044/201707/979044-20170710105934040-1007626405.gif</a></p></blockquote><p>因此就比较明显了,我们设计一个可视窗口组件<code>Frame</code>,然后将四个 <code>div</code>共同放入幻灯片组合组件<code>SlideList</code>中,并用<code>SlideItem</code>分别将 <code>div</code>包裹起来,实际代码应该是这样的:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>1
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>frame</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  2
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>SlideList</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    3
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>SlideItem</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      4
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          1h3&gt;div&gt; 5 SlideItem&gt; 6
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>SlideItem</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            7
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>              <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                2h3&gt;div&gt; 8 SlideItem&gt; 9
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>SlideItem</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                  10
</span></span><span class=line><span class=cl>                  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                      3h3&gt;div&gt; 11 SlideItem&gt; 12
</span></span><span class=line><span class=cl>                      <span class=p>&lt;</span><span class=nt>SlideItem</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                        13
</span></span><span class=line><span class=cl>                        <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                          <span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                            4h3&gt;div&gt; 14 SlideItem&gt; 15 SlideList&gt; 16 Frame&gt;
</span></span><span class=line><span class=cl>                          <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>SlideItem</span>
</span></span><span class=line><span class=cl>                      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>SlideItem</span>
</span></span><span class=line><span class=cl>                <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>              <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>SlideItem</span>
</span></span><span class=line><span class=cl>          <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;/</span><span class=nt>SlideItem</span>
</span></span><span class=line><span class=cl>    <span class=p>&gt;&lt;/</span><span class=nt>SlideList</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;&lt;/</span><span class=nt>frame</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们不断利用<code>translateX</code>来改变<code>SlideList</code>的位置来达到轮播效果,如下图所示,每次轮播的触发都是通过改变<code>transform: translateX()</code>来操作的</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182448.jpeg width=auto alt=img></p><a href=#42-轮播图基础实现><h4 id=42-轮播图基础实现><span class=hanchor arialabel=Anchor># </span>4.2 轮播图基础实现</h4></a><p>搞清楚基本原理那么实现起来相对容易了,我们以移动端的实现为例,来实现一个基础的移动端轮播图.</p><p>首先我们要确定<strong>可视窗口</strong>的宽度,因为我们需要这个宽度来计算出<code>SlideList</code>的长度(<code>SlideList</code>的长度通常是可视窗口的倍数,比如要放三张图片,那么<code>SlideList</code>应该为可视窗口的至少 3 倍),不然我们无法通过<code>translateX</code>来移动它.</p><p>我们通过<code>getBoundingClientRect</code>来获取可视区域真实的长度,<code>SlideList</code>的长度那么为:</p><p><code>slideListWidth = (len + 2) * width</code>(len 为传入子组件的数量,width 为可视区域宽度)</p><p>至于为什么要<code>+2</code>后面会提到.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl> <span class=mi>1</span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 2   * 设置轮播区域尺寸
</span></span></span><span class=line><span class=cl><span class=cm> 3   * @param x
</span></span></span><span class=line><span class=cl><span class=cm> 4   */</span>
</span></span><span class=line><span class=cl> <span class=mi>5</span>  <span class=kr>private</span> <span class=nx>setSize</span><span class=p>(</span><span class=nx>x?</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>6</span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>width</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>frameRef</span><span class=p>.</span><span class=nx>current</span><span class=o>!</span><span class=p>.</span><span class=nx>getBoundingClientRect</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=mi>7</span>    <span class=kr>const</span> <span class=nx>len</span> <span class=o>=</span> <span class=nx>React</span><span class=p>.</span><span class=nx>Children</span><span class=p>.</span><span class=nx>count</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span>    <span class=kr>const</span> <span class=nx>total</span> <span class=o>=</span> <span class=nx>len</span> <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>      <span class=nx>slideItemWidth</span>: <span class=kt>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>      <span class=nx>slideListWidth</span>: <span class=kt>total</span> <span class=o>*</span> <span class=nx>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>      <span class=nx>total</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>      <span class=nx>translateX</span><span class=o>:</span> <span class=o>-</span><span class=nx>width</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentIndex</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>      <span class=nx>startPositionX</span>: <span class=kt>x</span> <span class=o>!==</span> <span class=kc>undefined</span> <span class=o>?</span> <span class=nx>x</span> : <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>获取到了总长度之后如何实现轮播呢?我们需要根据用户反馈来触发轮播,在移动端通常是通过手指滑动来触发轮播,这就需要三个事件<code>onTouchStart</code> <code>onTouchMove``onTouchEnd</code>.</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182445.png width=auto alt=image-20200714181546085></p><p><code>onTouchStart</code>顾名思义是在手指触摸到屏幕时触发的事件,在这个事件里我们只需要记录下手指触摸屏幕的横轴坐标 x 即可,因为我们会通过其横向滑动的距离大小来判断是否触发轮播</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl> <span class=mi>1</span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 2   * 处理触摸起始时的事件
</span></span></span><span class=line><span class=cl><span class=cm> 3   *
</span></span></span><span class=line><span class=cl><span class=cm> 4   * @private
</span></span></span><span class=line><span class=cl><span class=cm> 5   * @param {React.TouchEvent} e
</span></span></span><span class=line><span class=cl><span class=cm> 6   * @memberof Carousel
</span></span></span><span class=line><span class=cl><span class=cm> 7   */</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span>  <span class=kr>private</span> <span class=nx>onTouchStart</span><span class=p>(</span><span class=nx>e</span>: <span class=kt>React.TouchEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span>    <span class=nx>clearInterval</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>autoPlayTimer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>    <span class=c1>// 获取起始的横轴坐标
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>11</span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>x</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getPosition</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setSize</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>      <span class=nx>startPositionX</span>: <span class=kt>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>onTouchMove</code>顾名思义是处于滑动状态下的事件,此事件在<code>onTouchStart</code>触发后,<code>onTouchEnd</code>触发前,在这个事件中我们主要做两件事,一件事是判断滑动方向,因为用户可能向左或者向右滑动,另一件事是让轮播图跟随手指移动,这是必要的用户反馈.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl> <span class=mi>1</span> <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 2   * 当触摸滑动时处理事件
</span></span></span><span class=line><span class=cl><span class=cm> 3   *
</span></span></span><span class=line><span class=cl><span class=cm> 4   * @private
</span></span></span><span class=line><span class=cl><span class=cm> 5   * @param {React.TouchEvent} e
</span></span></span><span class=line><span class=cl><span class=cm> 6   * @memberof Carousel
</span></span></span><span class=line><span class=cl><span class=cm> 7   */</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span>  <span class=kr>private</span> <span class=nx>onTouchMove</span><span class=p>(</span><span class=nx>e</span>: <span class=kt>React.TouchEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>slideItemWidth</span><span class=p>,</span> <span class=nx>currentIndex</span><span class=p>,</span> <span class=nx>startPositionX</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>x</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getPosition</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>    <span class=kr>const</span> <span class=nx>deltaX</span> <span class=o>=</span> <span class=nx>x</span> <span class=o>-</span> <span class=nx>startPositionX</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>    <span class=c1>// 判断滑动方向
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>14</span>    <span class=kr>const</span> <span class=nx>direction</span> <span class=o>=</span> <span class=nx>deltaX</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=s1>&#39;right&#39;</span> <span class=o>:</span> <span class=s1>&#39;left&#39;</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>      <span class=nx>direction</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>      <span class=nx>moveDeltaX</span>: <span class=kt>deltaX</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>      <span class=c1>// 改变translateX来达到轮播组件跟随手指移动的效果
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>20</span>      <span class=nx>translateX</span><span class=o>:</span> <span class=o>-</span><span class=p>(</span><span class=nx>slideItemWidth</span> <span class=o>*</span> <span class=nx>currentIndex</span><span class=p>)</span> <span class=o>+</span> <span class=nx>deltaX</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>onTouchEnd</code>顾名思义是滑动完毕时触发的事件,在此事件中我们主要做一个件事情,就是判断是否触发轮播,我们会设置一个阈值<code>threshold</code>,当滑动距离超过这个阈值时才会触发轮播,毕竟没有阈值的话用户稍微触碰轮播图就造成轮播,误操作会造成很差的用户体验.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl> <span class=mi>1</span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 2   * 滑动结束处理的事件
</span></span></span><span class=line><span class=cl><span class=cm> 3   *
</span></span></span><span class=line><span class=cl><span class=cm> 4   * @private
</span></span></span><span class=line><span class=cl><span class=cm> 5   * @memberof Carousel
</span></span></span><span class=line><span class=cl><span class=cm> 6   */</span>
</span></span><span class=line><span class=cl> <span class=mi>7</span>  <span class=kr>private</span> <span class=nx>onTouchEnd() {</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span>    <span class=k>this</span><span class=p>.</span><span class=nx>autoPlay</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>moveDeltaX</span><span class=p>,</span> <span class=nx>slideItemWidth</span><span class=p>,</span> <span class=nx>direction</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>    <span class=kr>const</span> <span class=nx>threshold</span> <span class=o>=</span> <span class=nx>slideItemWidth</span> <span class=o>*</span> <span class=nx>THRESHOLD_PERCENTAGE</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>    <span class=c1>// 判断是否轮播
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>12</span>    <span class=kr>const</span> <span class=nx>moveToNext</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>abs</span><span class=p>(</span><span class=nx>moveDeltaX</span><span class=p>)</span> <span class=o>&gt;</span> <span class=nx>threshold</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>    <span class=k>if</span> <span class=p>(</span><span class=nx>moveToNext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>        <span class=c1>// 如果轮播触发那么进行轮播操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>16</span>      <span class=k>this</span><span class=p>.</span><span class=nx>handleSwipe</span><span class=p>(</span><span class=nx>direction</span><span class=o>!</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>        <span class=c1>// 轮播不触发,那么轮播图回到原位
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>19</span>      <span class=k>this</span><span class=p>.</span><span class=nx>handleMisoperation</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>20</span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#43-轮播图的动画效果><h4 id=43-轮播图的动画效果><span class=hanchor arialabel=Anchor># </span>4.3 轮播图的动画效果</h4></a><p>我们常见的轮播图肯定不是生硬的切换,一般在轮播中会有一个渐变或者缓动的动画,这就需要我们加入动画效果.</p><p>我们制作动画通常有两个选择,一个是用 css3 自带的动画效果,另一个是用浏览器提供的 requestAnimationFrame API</p><p>孰优孰劣?css3 简单易用上手快,兼容性好,<code>requestAnimationFrame</code> 灵活性更高,能实现 css3 实现不了的动画,比如众多缓动动画 css3 都束手无策,因此我们毫无疑问地选择了<code>requestAnimationFrame</code>.</p><blockquote><p>双方对比请看张鑫旭大神的 CSS3 动画那么强，requestAnimationFrame 还有毛线用？</p></blockquote><p>想用<code>requestAnimationFrame</code>实现缓动效果就需要特定的缓动函数,下面就是典型的缓动函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=mi>1</span><span class=kr>type</span> <span class=nx>tweenFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>t</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>b</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>_c</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>d</span>: <span class=kt>number</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kt>number</span>
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=kr>const</span> <span class=nx>easeInOutQuad</span>: <span class=kt>tweenFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>_c</span><span class=p>,</span> <span class=nx>d</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>    <span class=kr>const</span> <span class=nx>c</span> <span class=o>=</span> <span class=nx>_c</span> <span class=o>-</span> <span class=nx>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>4</span>    <span class=k>if</span> <span class=p>((</span><span class=nx>t</span> <span class=o>/=</span> <span class=nx>d</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>5</span>      <span class=k>return</span> <span class=nx>c</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>*</span> <span class=nx>t</span> <span class=o>*</span> <span class=nx>t</span> <span class=o>+</span> <span class=nx>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>6</span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>7</span>      <span class=k>return</span> <span class=o>-</span><span class=nx>c</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>((</span><span class=o>--</span><span class=nx>t</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nx>t</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=nx>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>8</span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>9</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>缓动函数接收四个参数,分别是:</p><ul><li>t: 时间</li><li>b:初始位置</li><li>_c:结束的位置</li><li>d:速度</li></ul><p>通过这个函数我们能算出每一帧轮播图所在的位置, 如下:</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182438.jpeg width=auto alt=img></p><p>在获取每一帧对应的位置后,我们需要用<code>requestAnimationFrame</code>不断递归调用依次移动位置,我们不断调用<code>animation</code>函数是其触发函数体内的<code>this.setState({ translateX: tweenQueue[0], })</code>来达到移动轮播图位置的目的,此时将这数组内的 30 个位置依次快速执行就是一个缓动动画效果.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl> <span class=mi>1</span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> 2   * 递归调用,根据轨迹运动
</span></span></span><span class=line><span class=cl><span class=cm> 3   *
</span></span></span><span class=line><span class=cl><span class=cm> 4   * @private
</span></span></span><span class=line><span class=cl><span class=cm> 5   * @param {number[]} tweenQueue
</span></span></span><span class=line><span class=cl><span class=cm> 6   * @param {number} newIndex
</span></span></span><span class=line><span class=cl><span class=cm> 7   * @memberof Carousel
</span></span></span><span class=line><span class=cl><span class=cm> 8   */</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span>  <span class=kr>private</span> <span class=nx>animation</span><span class=p>(</span><span class=nx>tweenQueue</span>: <span class=kt>number</span><span class=p>[],</span> <span class=nx>newIndex</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>    <span class=k>if</span> <span class=p>(</span><span class=nx>tweenQueue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>11</span>      <span class=k>this</span><span class=p>.</span><span class=nx>handleOperationEnd</span><span class=p>(</span><span class=nx>newIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>      <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>      <span class=nx>translateX</span>: <span class=kt>tweenQueue</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>    <span class=nx>tweenQueue</span><span class=p>.</span><span class=nx>shift</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>    <span class=k>this</span><span class=p>.</span><span class=nx>rafId</span> <span class=o>=</span> <span class=nx>requestAnimationFrame</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>animation</span><span class=p>(</span><span class=nx>tweenQueue</span><span class=p>,</span> <span class=nx>newIndex</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但是我们发现了一个问题,当我们移动轮播图到最后的时候,动画出现了问题,<em>当我们向左滑动最后一个轮播图<code>div4</code>时,这种情况下应该是图片向左滑动,然后第一张轮播图<code>div1</code>进入可视区域,但是反常的是图片快速向右滑动<code>div1</code>出现在可是区域…</em></p><p>因为我们此时将位置 4 设置为了位置 1,这样才能达到不断循环的目的,但是也造成了这个副作用,图片行为与用户行为产生了相悖的情况(用户向左划动,图片向右走).</p><p>目前业界的普遍做法是将图片首尾相连,例如图片 1 前面连接一个图片 4,图片 4 后跟着一个图片 1,这就是为什么之前计算长度时要<code>+2</code></p><p><code>slideListWidth = (len + 2) * width</code>(len 为传入子组件的数量,width 为可视区域宽度)</p><p>当我们移动图片 4 时就不会出现上述向左滑图片却向右滑的情况,因为真实情况是:</p><p><code>图片4 -- 滑动为 -> 伪图片1</code> 也就是位置 5 变成了位置 6</p><p>当动画结束之后,我们迅速把<code>伪图片1</code>的位置设置为<code>真图片1</code>,这其实是个障眼法,也就是说动画执行过程中实际上是<code>图片4</code>到<code>伪图片1</code>的过程,当结束后我们偷偷把<code>伪图片1</code>换成<code>真图片1</code>,因为两个图一模一样,所以这个转换的过程用户根本看不出来…</p><p>如此一来我们就可以实现无缝切换的轮播图了</p><a href=#44-改进方向><h4 id=44-改进方向><span class=hanchor arialabel=Anchor># </span>4.4 改进方向</h4></a><p>我们实现了轮播图的基本功能,但是其通用性依然存在缺陷:</p><ol><li>提示点的自定义: 我的实现是一个小点,而 antd 是用的条,这个地方完全可以将 dom 结构的决定权交给开发者.</li></ol><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182059.png width=auto alt=img></p><ol><li>方向的自定义: 本轮播图只有水平方向的实现,其实也可以有纵向轮播</li></ol><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182106.png width=auto alt=img></p><ol><li>多张轮播:除了单张轮播也可以多张轮播</li></ol><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182431.png width=auto alt=img></p><p>以上都是可以对轮播图进行拓展的方向,相关的还有性能优化方面</p><p>我们的具体代码中有一个相关实现,我们的轮播图其实是有自动轮播功能的,但是很多时候页面并不在用户的可视页面中,我们可以根据是否页面被隐藏来取消定时器终止自动播放.</p><p><img src=https://cdn.jsdelivr.net/gh/radoapx/rax-picbed/PicGo/notes/frontend/frontendcomponent/20210410182425.png width=auto alt=img></p><p>github 项目地址</p><blockquote><p><a href=https://github.com/xiaomuzhu/rc-carousel rel=noopener>https://github.com/xiaomuzhu/rc-carousel</a></p></blockquote></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/%E5%89%8D%E7%AB%AF/ data-ctx=组件库设计 data-src=/%E5%89%8D%E7%AB%AF class=internal-link>前端</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://jieye-ericx.github.io/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Jieye ericx using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://jieye-ericx.github.io/>Home</a></li><li><a href=https://github.com/jieye-ericx>Github</a></li></ul></footer></div></div></body></html>